<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />

<script src="jQuery/jquery-1.6.1.min.js"></script>
<script src="unhosted/config.js" onerror="window.location='unhosted/install.php';"></script>
<script src="unhosted/wallet.js"></script>
<script src="unhosted/sjcl/sjcl.js"></script>
<script src="unhosted/base64.js"></script>
<script src="unhosted/unhosted.js"></script>
<script>
$(document).ready(function() {
	if (window.location != config.appUrl) {
		window.location = config.appUrl;
	}
	start();
});

  ////////////////////
 //  global vars:  //
////////////////////

var unhosted = Unhosted();
var currentUser;
var docList;

  //////////////////
 // data access: //
//////////////////

function start() {
	unhosted.connect();						//if you get past this, it means the user is logged in.
	currentUser = unhosted.getUserName();				//see the user address that's logged in.
	unhosted.get(
		'docList', 						//key
		function() {						//requirePwd 
			alert('please put in your password');
			docList = null;
			show();
		},
		//requirePwd 
		function(ret) {						//cb
			docList = ret;
			show();						//put values into the DOM.
		});
}

function onsave() {
	docList = {docs:
			[{name:document.getElementById('docName').value,
			text:document.getElementById('docText').value}]
		};
	unhosted.set(
		'docList', 
		docList,//
		function() {//cb
			unhosted.get(//double check that it was saved successfully.
				'docList',
				function() {alert('failed to save!');},
				function(ret) {
					docList = ret;
					show();				//update the DOM.
				});
		});							//save newly set ingredients.
}

function onlogout() {
	unhosted.close();						//after this, the user is logged out.
}

function goCrypto() {
	if(document.getElementById('pwd2').type=="hidden") {
		unhosted.setCryptoPwd(
			document.getElementById('pwd1').value,
			function() {//callback in case this is the first time
				document.getElementById('pwd2').type="password";
				alert('repeat the same password to use it for the first time, please');
			},
			function() {
				alert('oops');
			},
			function() {
				document.getElementById('pwd1').type = "hidden"; 
				document.getElementById('goCrypto').type = "hidden"; 
				start();
			});
	} else {
		if (document.getElementById('pwd1').value == document.getElementById('pwd2').value) {
			unhosted.setCryptoPwd(
				document.getElementById('pwd1').value,
				null,
				function() {
					alert('oops');
				},
				function() {
					document.getElementById('pwd1').type = "hidden"; 
					document.getElementById('pwd2').type = "hidden"; 
					document.getElementById('goCrypto').type = "hidden"; 
				});
		} else {
			alert("passwords don't match!");
		}
	}
}

  /////////////////////
 //  presentation:  //
/////////////////////

function show() {
	if(!docList) {
		docList = {docs:[{name:'', text:''}]};
	}
	document.getElementById('showDocName').innerHTML = docList.docs[0].name;
	document.getElementById('showDocText').innerHTML = docList.docs[0].text;
	document.getElementById('docName').value = docList.docs[0].name;
	document.getElementById('docText').value = docList.docs[0].text;
	document.getElementById('currentUser').innerHTML =
		'Current user is <strong>'
		+currentUser
		+'</strong> [<a onclick="onlogout();">Log out</a>]'
		+'<br> <input type="hidden" id="pwd1">'
		+' <input type="hidden" id="pwd2">'
		+' <input type="hidden" id="goCrypto" value="Go crypto" onclick="goCrypto();">';
	if(unhosted.getMode() == 'clear') {
		document.getElementById('pwd1').type = "password"; 
		document.getElementById('goCrypto').type = "submit"; 
	}
}

</script>
</head>
<body>
<div id="mainWrap">
	<div id="unlockedView">
		<div id="preheader">
			<span>
				<span id="currentUser"></span>
			</span>
		</div>
			
		<header class="data">
			<p>Doc <strong><span id="showDocName"></span></strong> text: 
				<strong><span id="showDocText"></span></strong> edit:</p>
			<input id="docName" placeholder='test.txt' type="text"/>
			<input class="submitingredients" type="submit" value="Submit!" onclick="onsave();"/>
			<br>
				<textarea cols="80" rows="20" id="docText" placeholder='bla'/>	
		</header>
	</div>
</div>
</body>
</html>
